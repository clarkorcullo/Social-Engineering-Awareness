{% extends "base.html" %}
{% block title %}Final Assessment - Social Engineering Awareness{% endblock %}
{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow-lg">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex align-items-center gap-3 mb-2">
                        <img src="{{ url_for('static', filename='MMDCLogo.png') }}" alt="MMDC Logo" style="height: 40px; width: auto; border-radius: 6px;">
                        <img src="{{ url_for('static', filename='SEALogo.png') }}" alt="SEA Logo" style="height: 40px; width: auto; border-radius: 6px;">
                    </div>
                    <h3 class="card-title mb-0">
                        <i class="fas fa-graduation-cap"></i> Final Assessment
                    </h3>
                    <p class="mb-0">Comprehensive evaluation of all learning outcomes</p>
                </div>
                <div class="card-body p-4">
                    <!-- Assessment Rules -->
                    <div class="alert alert-warning mb-4">
                        <h5><i class="fas fa-exclamation-triangle"></i> Important Assessment Rules</h5>
                        <ul class="mb-0">
                            <li><strong>Questions:</strong> 25 comprehensive questions covering all modules</li>
                            <li><strong>Passing Rate:</strong> 80% (20 out of 25 correct)</li>
                            <li><strong>Maximum Attempts:</strong> 3 attempts only</li>
                            <li><strong>Consequence:</strong> If you fail all 3 attempts, you must restart all modules</li>
                            <li><strong>Question Randomization:</strong> Questions are randomized on each attempt</li>
                        </ul>
                    </div>

                    <!-- Attempts Information -->
                    <div class="alert alert-info mb-4">
                        <h6><i class="fas fa-info-circle"></i> Your Attempts</h6>
                        <p class="mb-0">
                            <strong>Remaining Attempts:</strong> {{ remaining_attempts }} out of {{ total_attempts }}<br>
                            <strong>Status:</strong> 
                            {% if remaining_attempts > 0 %}
                                <span class="text-success">Ready to take assessment</span>
                            {% else %}
                                <span class="text-danger">No attempts remaining - must restart modules</span>
                            {% endif %}
                        </p>
                    </div>

                    <!-- Assessment Interface -->
                    <div id="assessment-interface" style="display: none;">
                        <div class="progress mb-4">
                            <div class="progress-bar" role="progressbar" style="width: 0%" id="question-progress"></div>
                        </div>

                        <div id="question-container">
                            <!-- Questions will be loaded here -->
                        </div>

                        <div class="d-flex justify-content-between mt-4">
                            <button class="btn btn-secondary" id="prev-btn" style="display: none;">
                                <i class="fas fa-arrow-left"></i> Previous
                            </button>
                            <button class="btn btn-primary" id="next-btn">
                                Next <i class="fas fa-arrow-right"></i>
                            </button>
                            <button class="btn btn-success" id="submit-btn" style="display: none;">
                                <i class="fas fa-check"></i> Submit Final Assessment
                            </button>
                        </div>
                    </div>

                    <!-- Start Assessment Button -->
                    <div id="start-section" class="text-center" {% if remaining_attempts <= 0 %}style="display: none;"{% endif %}>
                        <h5 class="mb-4">Ready for your Final Assessment?</h5>
                        <p class="text-muted mb-4">This comprehensive assessment covers all learning modules. Make sure you're prepared!</p>
                        <button class="btn btn-primary btn-lg" id="start-assessment" {% if remaining_attempts <= 0 %}disabled{% endif %}>
                            <i class="fas fa-play"></i> Start Final Assessment
                        </button>
                    </div>

                    <!-- No Attempts Remaining -->
                    <div id="no-attempts-section" class="text-center" {% if remaining_attempts > 0 %}style="display: none;"{% endif %}>
                        <div class="alert alert-danger">
                            <h5><i class="fas fa-times-circle"></i> No Attempts Remaining</h5>
                            <p>You have used all 3 attempts for the final assessment. You must restart all modules to try again.</p>
                        </div>
                        <a href="{{ url_for('dashboard') }}" class="btn btn-primary">
                            <i class="fas fa-home"></i> Go to Dashboard
                        </a>
                    </div>

                    <!-- Results Section -->
                    <div id="results-section" style="display: none;">
                        <div class="text-center mb-4">
                            <h4 id="result-title"></h4>
                            <div class="alert" id="result-alert">
                                <p id="result-message"></p>
                                <p><strong>Score:</strong> <span id="result-score"></span></p>
                                <p><strong>Correct Answers:</strong> <span id="result-correct"></span> out of <span id="result-total"></span></p>
                                <p><strong>Attempts Used:</strong> <span id="result-attempts"></span> out of 3</p>
                            </div>
                        </div>

                        <div id="retake-section" style="display: none;">
                            <div class="text-center">
                                <button class="btn btn-primary" id="retake-btn">
                                    <i class="fas fa-redo"></i> Take Again
                                </button>
                                <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
                                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                                </a>
                            </div>
                        </div>

                        <div id="pass-section" style="display: none;">
                            <div class="text-center">
                                <div class="alert alert-success">
                                    <h5><i class="fas fa-trophy"></i> Congratulations!</h5>
                                    <p>You have successfully passed the Final Assessment!</p>
                                </div>
                                <a href="{{ url_for('survey') }}" class="btn btn-success">
                                    <i class="fas fa-clipboard-list"></i> Complete Survey
                                </a>
                                <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
                                    <i class="fas fa-home"></i> Go to Dashboard
                                </a>
                            </div>
                        </div>

                        <div id="fail-section" style="display: none;">
                            <div class="text-center">
                                <div class="alert alert-danger">
                                    <h5><i class="fas fa-exclamation-triangle"></i> Assessment Failed</h5>
                                    <p>You have used all 3 attempts. You must restart all modules to try again.</p>
                                </div>
                                <a href="{{ url_for('dashboard') }}" class="btn btn-primary">
                                    <i class="fas fa-home"></i> Go to Dashboard
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentQuestions = [];
let currentQuestionIndex = 0;
let userAnswers = {};
let startTime = null;

// Start assessment
document.getElementById('start-assessment')?.addEventListener('click', function() {
    startAssessment();
});

// Load questions from API
async function startAssessment() {
    try {
        const response = await fetch('/api/final-assessment/questions');
        const data = await response.json();
        
        if (data.error) {
            alert('Error loading questions: ' + data.error);
            return;
        }
        
        currentQuestions = data.questions;
        userAnswers = {};
        currentQuestionIndex = 0;
        startTime = Date.now();
        
        // Hide start section and show assessment
        document.getElementById('start-section').style.display = 'none';
        document.getElementById('assessment-interface').style.display = 'block';
        
        // Load first question
        loadQuestion(0);
        
    } catch (error) {
        console.error('Error:', error);
        alert('Error loading questions. Please try again.');
    }
}

// Load question at specific index
function loadQuestion(index) {
    if (index < 0 || index >= currentQuestions.length) return;
    
    const question = currentQuestions[index];
    const container = document.getElementById('question-container');
    
    // Update progress
    const progress = ((index + 1) / currentQuestions.length) * 100;
    document.getElementById('question-progress').style.width = progress + '%';
    
    // Create question HTML
    container.innerHTML = `
        <div class="question-card">
            <h4 class="mb-3">Question ${index + 1} of ${currentQuestions.length}</h4>
            <p class="question-text mb-4">${question.question_text}</p>
            
            <div class="options">
                <div class="form-check mb-3">
                    <input class="form-check-input" type="radio" name="question_${question.id}" id="option_a_${question.id}" value="a" ${userAnswers[question.id] === 'a' ? 'checked' : ''}>
                    <label class="form-check-label" for="option_a_${question.id}">
                        <strong>A.</strong> ${question.options.a}
                    </label>
                </div>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="radio" name="question_${question.id}" id="option_b_${question.id}" value="b" ${userAnswers[question.id] === 'b' ? 'checked' : ''}>
                    <label class="form-check-label" for="option_b_${question.id}">
                        <strong>B.</strong> ${question.options.b}
                    </label>
                </div>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="radio" name="question_${question.id}" id="option_c_${question.id}" value="c" ${userAnswers[question.id] === 'c' ? 'checked' : ''}>
                    <label class="form-check-label" for="option_c_${question.id}">
                        <strong>C.</strong> ${question.options.c}
                    </label>
                </div>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="radio" name="question_${question.id}" id="option_d_${question.id}" value="d" ${userAnswers[question.id] === 'd' ? 'checked' : ''}>
                    <label class="form-check-label" for="option_d_${question.id}">
                        <strong>D.</strong> ${question.options.d}
                    </label>
                </div>
            </div>
        </div>
    `;
    
    // Update navigation buttons
    updateNavigationButtons();
    
    // Save answer when user selects an option
    document.querySelectorAll(`input[name="question_${question.id}"]`).forEach(radio => {
        radio.addEventListener('change', function() {
            userAnswers[question.id] = this.value;
        });
    });
}

// Update navigation buttons
function updateNavigationButtons() {
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const submitBtn = document.getElementById('submit-btn');
    
    prevBtn.style.display = currentQuestionIndex > 0 ? 'block' : 'none';
    nextBtn.style.display = currentQuestionIndex < currentQuestions.length - 1 ? 'block' : 'none';
    submitBtn.style.display = currentQuestionIndex === currentQuestions.length - 1 ? 'block' : 'none';
}

// Navigation button handlers
document.getElementById('prev-btn').addEventListener('click', function() {
    if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        loadQuestion(currentQuestionIndex);
    }
});

document.getElementById('next-btn').addEventListener('click', function() {
    if (currentQuestionIndex < currentQuestions.length - 1) {
        currentQuestionIndex++;
        loadQuestion(currentQuestionIndex);
    }
});

// Submit assessment
document.getElementById('submit-btn').addEventListener('click', function() {
    submitAssessment();
});

async function submitAssessment() {
    // Check if all questions are answered
    const answeredQuestions = Object.keys(userAnswers).length;
    if (answeredQuestions < currentQuestions.length) {
        alert('Please answer all questions before submitting.');
        return;
    }
    
    const timeTaken = Math.floor((Date.now() - startTime) / 1000);
    
    try {
        const response = await fetch('/api/final-assessment/submit', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                answers: userAnswers,
                time_taken: timeTaken
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showResults(result);
        } else {
            alert('Error submitting assessment: ' + result.error);
        }
        
    } catch (error) {
        console.error('Error:', error);
        alert('Error submitting assessment. Please try again.');
    }
}

// Show results
function showResults(result) {
    document.getElementById('assessment-interface').style.display = 'none';
    document.getElementById('results-section').style.display = 'block';
    
    const resultTitle = document.getElementById('result-title');
    const resultAlert = document.getElementById('result-alert');
    const resultMessage = document.getElementById('result-message');
    const resultScore = document.getElementById('result-score');
    const resultCorrect = document.getElementById('result-correct');
    const resultTotal = document.getElementById('result-total');
    const resultAttempts = document.getElementById('result-attempts');
    
    if (result.passed) {
        resultTitle.textContent = 'ðŸŽ‰ Congratulations! You Passed!';
        resultAlert.className = 'alert alert-success';
        resultMessage.textContent = result.message;
    } else {
        resultTitle.textContent = 'ðŸ“š Assessment Result';
        resultAlert.className = 'alert alert-warning';
        resultMessage.textContent = result.message;
    }
    
    resultScore.textContent = result.score + '%';
    resultCorrect.textContent = result.correct_answers;
    resultTotal.textContent = result.total_questions;
    resultAttempts.textContent = result.attempts_used;
    
    // Show appropriate buttons
    if (result.passed) {
        document.getElementById('pass-section').style.display = 'block';
        document.getElementById('retake-section').style.display = 'none';
        document.getElementById('fail-section').style.display = 'none';
    } else if (result.remaining_attempts > 0) {
        document.getElementById('pass-section').style.display = 'none';
        document.getElementById('retake-section').style.display = 'block';
        document.getElementById('fail-section').style.display = 'none';
    } else {
        document.getElementById('pass-section').style.display = 'none';
        document.getElementById('retake-section').style.display = 'none';
        document.getElementById('fail-section').style.display = 'block';
    }
}

// Retake button
document.getElementById('retake-btn')?.addEventListener('click', function() {
    document.getElementById('results-section').style.display = 'none';
    document.getElementById('start-section').style.display = 'block';
});
</script>

<style>
.question-card {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
}

.question-text {
    font-size: 1.1em;
    font-weight: 500;
    color: #2c3e50;
}

.options .form-check {
    background: white;
    border-radius: 8px;
    padding: 15px;
    border: 2px solid #e9ecef;
    transition: all 0.3s ease;
}

.options .form-check:hover {
    border-color: #007bff;
    background-color: #f8f9fa;
}

.options .form-check-input:checked + .form-check-label {
    font-weight: 600;
    color: #007bff;
}

.progress {
    height: 8px;
    border-radius: 4px;
}
</style>
{% endblock %} 